#!/bin/bash
#

set -e

log() {
  echo "$1"
}

config_path="/boot/hotspot.txt"

if [ -f $config_path ]; then

  log "Config file found at $config_path, activating access point"

  hotspot_ssid=$(sed -n -e 's/^ssid=\(.\+\)$/\1/p' /boot/hotspot.txt)
  hotspot_ssid="${hotspot_ssid:-RpiAccessPoint}"
  if [ ${#hotspot_ssid} -lt 1 ] || [ ${#hotspot_ssid} -gt 32 ]; then
    hotspot_ssid="RpiAccessPoint"
  fi

  hotspot_passphrase=$(sed -n -e 's/^passphrase=\(.\+\)$/\1/p' /boot/hotspot.txt)
  hotspot_passphrase="${hotspot_passphrase:-rpi_ap_pass}"
  if [ ${#hotspot_passphrase} -lt 8 ] || [ ${#hotspot_passphrase} -gt 63 ]; then
    hotspot_passphrase="rpi_ap_pass"
  fi

  sed -i "s/^ssid=.*/ssid=$hotspot_ssid/g" /etc/hostapd/hostapd.conf
  sed -i "s/^wpa_passphrase=.*/wpa_passphrase=$hotspot_passphrase/g" /etc/hostapd/hostapd.conf

  log "ssid: $hotspot_ssid will be used"

  if ! grep "^denyinterfaces wlan0$" /etc/dhcpcd.conf; then
    log "dhcpcd will ignore wlan0"
    echo "denyinterfaces wlan0" | tee -a /etc/dhcpcd.conf
    systemctl restart dhcpcd
  fi

  wpa_pid=$(pgrep wpa_supplicant)
  if [ -n "$wpa_pid" ]; then
    log "Stopping wpa_supplicant"
    kill "$wpa_pid"
  fi

  if [ "$(sysctl -n net.ipv4.ip_forward 2>/dev/null)" -eq "0" ]; then
    sysctl -q -w net.ipv4.ip_forward=1
    sysctl -p
  fi

  if ! iptables -t nat -C POSTROUTING -o eth0 -j MASQUERADE > /dev/null 2>&1; then
    iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
  fi

  if ! iptables -C FORWARD -i eth0 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT > /dev/null 2>&1; then
    iptables -A FORWARD -i eth0 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT
  fi

  if ! iptables -C FORWARD -i wlan0 -o eth0 -j ACCEPT > /dev/null 2>&1; then
    iptables -A FORWARD -i wlan0 -o eth0 -j ACCEPT
  fi

  ifdown wlan0 &>/dev/null
  ifconfig wlan0 10.99.99.1
  ifup wlan0

  systemctl daemon-reload
  systemctl restart networking
  systemctl restart dnsmasq
  systemctl stop hostapd

  # hostapd won't use new config if it has been changed.
  # `sleep` seems to make it work
  sleep 5
  systemctl start hostapd

  log "Access point UP"
else
  log "Deactivating access point"

  if grep "^denyinterfaces wlan0$" /etc/dhcpcd.conf; then
    sed -i "/denyinterfaces wlan0/d" /etc/dhcpcd.conf
    systemctl restart dhcpcd
  fi

  if iptables -t nat -C POSTROUTING -o eth0 -j MASQUERADE > /dev/null 2>&1; then
    iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
  fi

  if iptables -C FORWARD -i eth0 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT > /dev/null 2>&1; then
    iptables -D FORWARD -i eth0 -o wlan0 -m state --state RELATED,ESTABLISHED -j ACCEPT
  fi

  if iptables -C FORWARD -i wlan0 -o eth0 -j ACCEPT > /dev/null 2>&1; then
    iptables -D FORWARD -i wlan0 -o eth0 -j ACCEPT
  fi

  if [ "$(sysctl -n net.ipv4.ip_forward 2>/dev/null)" -eq "1" ]; then
    sysctl -q -w net.ipv4.ip_forward=0
    sysctl -p
  fi

  systemctl stop dnsmasq
  systemctl stop hostapd

  ifdown wlan0 &>/dev/null
  ifconfig wlan0 0.0.0.0
  ifup wlan0

  systemctl restart networking

  wpa_pid=$(pgrep wpa_supplicant)
  if [ -n "$wpa_pid" ]; then
    log "Stopping wpa_supplicant"
    kill "$wpa_pid"
  fi

  log "Starting wpa_supplicant with config: /etc/wpa_supplicant/wpa_supplicant.conf"
  wpa_supplicant -B -i wlan0 -c /etc/wpa_supplicant/wpa_supplicant.conf > /dev/null

  log "Access point DOWN"
fi

exit 0
