#!/bin/bash
#

if [ -f /boot/hotspot.txt ]; then
  hotspot_ssid=$(sed -n -e 's/^ssid=\([[:alnum:]]\+\)/\1/p' /boot/hotspot.txt)
  hotspot_ssid="${hotspot_ssid:-PoppyHotspot}"
  hotspot_passphrase=$(sed -n -e 's/^passphrase=\([[:alnum:]]\+\)/\1/p' /boot/hotspot.txt)
  hotspot_passphrase="${hotspot_passphrase:-poppyproject}"

  sed -i "s/ssid=.*/ssid=$hotspot_ssid/g" /etc/hostapd/hostapd.conf
  sed -i "s/passphrase=.*/passphrase=$hotspot_passphrase/g" /etc/hostapd/hostapd.conf

  ip link set dev wlan0 down
  ip a add 192.168.0.1/24 dev wlan0
  ip link set dev wlan0 up
  systemctl start dnsmasq
  systemctl start hostapd
else
  wpa_supplicant -B -i wlan0 -c /etc/wpa_supplicant/wpa_supplicant.conf > /dev/null 2>&1
fi
